name: Check Database Connection

on:
  push:
    branches:
      - '**'
  pull_request:
  workflow_dispatch:

jobs:
  check-database:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Check DATABASE_URL is set
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "ERROR: DATABASE_URL is not set"
            exit 1
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Test database connection
        run: |
          # Extract host from DATABASE_URL
          HOST=$(echo "$DATABASE_URL" | sed -E 's|.*://[^@]+@([^/:]+).*|\1|')
          PORT=$(echo "$DATABASE_URL" | sed -E 's|.*://[^@]+@[^:]+:([0-9]+).*|\1|' || echo "5432")
          USER=$(echo "$DATABASE_URL" | sed -E 's|.*://([^@]+)@.*|\1|')
          PASSWORD=$(echo "$DATABASE_URL" | sed -E 's|.*://[^@]+:([^@]+)@.*|\1|')

          echo "Testing connection to $HOST:$PORT..."

          # Try to connect using psql with SSL (required for CockroachDB Cloud)
          # Use both defaultdb and postgres as some services use different default DBs
          if PGPASSWORD="$PASSWORD" PGSSLMODE=require psql -h "$HOST" -p "$PORT" -U "$USER" -d defaultdb -c "SELECT 1" > /dev/null 2>&1 || \
             PGPASSWORD="$PASSWORD" PGSSLMODE=require psql -h "$HOST" -p "$PORT" -U "$USER" -d postgres -c "SELECT 1" > /dev/null 2>&1; then
            echo "SUCCESS: Database connection successful"
          else
            echo "FAILED: Could not connect to database"
            exit 1
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt

      - name: Run database migrations
        run: |
          alembic upgrade head
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
